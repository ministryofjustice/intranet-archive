apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  namespace: intranet-archive-dev
  labels:
    prometheus: prometheus-operator
    role: alert-rules
    release: prometheus-operator
  name: monitoring-rules-intranet-archive
spec:
  groups:
    - name: application-rules
      rules:
      - # - - - - - - - - - - - - - - -
        # System
        # - service is down
        # - low disk space
        # - - - - - - - - - - - - - - -
        alert: ServiceDown
        # Service is down AND it's after 6am and it's before 10pm UK time - this accounts for the development environment's scheduled down time.
        expr: |
          max by(service, namespace) (up{namespace="intranet-archive-dev", service="intranet-archive-service"}) == 0 AND ON() (6 <= hour() < 22)
        for: 20m
        labels:
          # TODO update severity when issued by Cloud Platform. Also update in README.md
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - the service is down.
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#ServiceDown
      - alert: PersistentVolumeLowSpace
        expr: kubelet_volume_stats_available_bytes{namespace="intranet-archive-dev"} / 1e9 < 32
        for: 10m
        labels:
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - volume is nearly full {{ $labels.persistentvolumeclaim }} {{ printf "%0.0f" $value}} GB available. 
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#PersistentVolumeLowSpace
      - # - - - - - - - - - - - - - - -
        # S3
        # - failed bucket access
        # - - - - - - - - - - - - - - -
        alert: S3FailedBucketAccess
        expr: bucket_access{namespace="intranet-archive-dev"} != 1
        for: 10m
        labels:
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - S3 bucket used for snapshots, is inaccessible.
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#S3FailedBucketAccess
      - # - - - - - - - - - - - - - - -
        # CloudFront
        # - absent metric
        # - insufficient access policy
        # - - - - - - - - - - - - - - -
        alert: CloudFrontAbsentAccessPolicy
        # A service is up, and the metric is absent. This accounts for the service being down, i.e. out of office hours on development environments.
        expr: up{namespace="intranet-archive-dev"} == 1 AND absent(cdn_forbidden{namespace="intranet-archive-dev"}) == 1
        for: 20m
        labels:
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - CDN may be publicly accessible, metric is absent.
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#CloudFrontAbsentAccessPolicy
      - alert: CloudFrontInsufficientAccessPolicy
        expr: cdn_forbidden{namespace="intranet-archive-dev"} != 1
        for: 10m
        labels:
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - CDN is publicly accessible!
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#CloudFrontInsufficientAccessPolicy
      - # - - - - - - - - - - - - - - -
        # Intranet
        # - insufficient http access
        # - - - - - - - - - - - - - - -
        alert: IntranetFailedHttpAccess
        expr: min by(env, namespace) (intranet_access{namespace="intranet-archive-dev"}) != 1
        for: 10m
        labels:
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - the intranet ({{ $labels.env }}) returned a non-200 status code. 
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#IntranetFailedHttpAccess
      - # - - - - - - - - - - - - - - -
        # Application 
        # - weekly snapshots failed
        # - - - - - - - - - - - - - - -
        alert: SnapshotScheduleFailed
        expr: min by(agency, env, namespace) (most_recent_snapshot_age{namespace="intranet-archive-dev"}) > 14
        for: 10m
        labels:
          severity: intranet-dev
        annotations:
          message: Namespace {{ $labels.namespace }} - the most recent snapshot for {{ $labels.env }} {{ $labels.agency }} is {{ printf "%0.0f" $value}} days old. 
          dashboard_url: https://grafana.live.cloud-platform.service.justice.gov.uk/d/xywyqxz07sxkwg/cdpt-intranet-archive?var-namespace=intranet-archive-dev
          runbook_url: https://dsdmoj.atlassian.net/wiki/spaces/CDPT/pages/5124292758/Alerts+runbooks#SnapshotScheduleFailed
